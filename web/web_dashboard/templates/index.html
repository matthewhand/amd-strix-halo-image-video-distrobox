<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wan Video Generation Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }
        .generating { animation: pulse-glow 2s infinite; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                        <span class="text-purple-600 font-bold text-xl">🎬</span>
                    </div>
                    <h1 class="text-3xl font-bold">Wan Video Generation Studio</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="status-indicator" class="flex items-center">
                        <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                        <span class="text-sm">Connected</span>
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Stats Overview -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Total Jobs</p>
                        <p id="total-jobs" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                        <span>📊</span>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Completed</p>
                        <p id="completed-jobs" class="text-3xl font-bold text-green-400">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                        <span>✅</span>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Processing</p>
                        <p id="active-jobs" class="text-3xl font-bold text-yellow-400">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center">
                        <span>⚡</span>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">GPU Memory</p>
                        <p id="gpu-memory" class="text-3xl font-bold">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center">
                        <span>🧠</span>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Video Generation Form -->
            <section class="lg:col-span-1">
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-2">🎨</span> Create Video
                    </h2>

                    <form id="video-form" class="space-y-4">
                        <!-- Prompt Input -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Prompt</label>
                            <textarea id="prompt"
                                class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                rows="3"
                                placeholder="Describe your video..."></textarea>
                        </div>

                        <!-- Image Upload -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Input Image (Optional)</label>
                            <input type="file" id="image-upload" accept="image/*"
                                class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg">
                        </div>

                        <!-- Quality Preset -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Quality Preset</label>
                            <select id="quality-preset"
                                class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg">
                                <option value="draft">Draft (Fast)</option>
                                <option value="standard" selected>Standard</option>
                                <option value="high">High Quality</option>
                                <option value="ultra">Ultra Quality</option>
                                <option value="cinema">Cinema Quality</option>
                            </select>
                        </div>

                        <!-- Template Selection -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Template</label>
                            <select id="template"
                                class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg">
                                <option value="">Custom</option>
                            </select>
                        </div>

                        <!-- Advanced Options -->
                        <details class="bg-gray-800 rounded-lg p-4">
                            <summary class="cursor-pointer font-medium">Advanced Options</summary>
                            <div class="mt-4 space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Frames</label>
                                        <input type="number" id="frames" value="16" min="4" max="64"
                                            class="w-full px-3 py-1 bg-gray-700 border border-gray-600 rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">FPS</label>
                                        <input type="number" id="fps" value="8" min="4" max="30"
                                            class="w-full px-3 py-1 bg-gray-700 border border-gray-600 rounded">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Noise Level</label>
                                    <select id="noise-level"
                                        class="w-full px-3 py-1 bg-gray-700 border border-gray-600 rounded">
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high" selected>High</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Priority</label>
                                    <input type="number" id="priority" value="0" min="0" max="10"
                                        class="w-full px-3 py-1 bg-gray-700 border border-gray-600 rounded">
                                </div>
                            </div>
                        </details>

                        <!-- Submit Button -->
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                            <span id="submit-text">🚀 Generate Video</span>
                        </button>
                    </form>
                </div>

                <!-- Quick Templates -->
                <div class="glass-effect rounded-xl p-6 mt-6">
                    <h3 class="text-xl font-bold mb-4">🎯 Quick Templates</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="template-btn bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm transition" data-template="subtle_breathing">
                            Breathing
                        </button>
                        <button class="template-btn bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm transition" data-template="gentle_pulse">
                            Pulse
                        </button>
                        <button class="template-btn bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm transition" data-template="slow_pan">
                            Pan
                        </button>
                        <button class="template-btn bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm transition" data-template="wind_sway">
                            Wind
                        </button>
                    </div>
                </div>
            </section>

            <!-- Jobs and Visualization -->
            <section class="lg:col-span-2 space-y-6">
                <!-- Queue Status -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">⏳</span> Queue Status
                    </h3>
                    <div id="queue-info" class="space-y-2">
                        <p class="text-gray-400">Loading queue information...</p>
                    </div>
                </div>

                <!-- Recent Jobs -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">📋</span> Recent Jobs
                    </h3>
                    <div id="jobs-list" class="space-y-3">
                        <p class="text-gray-400">Loading recent jobs...</p>
                    </div>
                </div>

                <!-- GPU Monitoring Chart -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">📊</span> GPU Performance
                    </h3>
                    <canvas id="gpu-chart" width="400" height="200"></canvas>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-16 py-8 border-t border-gray-800">
        <div class="container mx-auto px-4 text-center text-gray-400">
            <p>Wan Video Generation Studio • Powered by AMD Strix Halo ROCm</p>
        </div>
    </footer>

    <script>
        // API Configuration
        const API_BASE = '/api';
        let gpuChart = null;
        let activeJobs = new Map();

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            loadTemplates();
            loadStats();
            loadJobs();
            loadQueueStatus();

            // Start real-time updates
            setInterval(loadStats, 3000);
            setInterval(loadJobs, 5000);
            setInterval(loadQueueStatus, 3000);

            // Setup form handlers
            setupFormHandlers();
        });

        // Initialize GPU Chart
        function initializeChart() {
            const ctx = document.getElementById('gpu-chart').getContext('2d');
            gpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'GPU Memory %',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Temperature °C',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Memory %'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Temperature °C'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
        }

        // Load Templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/presets`);
                const data = await response.json();

                const templateSelect = document.getElementById('template');
                templateSelect.innerHTML = '<option value="">Custom</option>';

                // Add templates from API (would need endpoint for this)
                const commonTemplates = [
                    'subtle_breathing', 'gentle_pulse', 'slow_pan',
                    'wind_sway', 'water_ripple', 'action_zoom'
                ];

                commonTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template;
                    option.textContent = template.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    templateSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        }

        // Load Statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();

                // Update stats display
                document.getElementById('total-jobs').textContent = data.jobs.total;
                document.getElementById('completed-jobs').textContent = data.jobs.completed;
                document.getElementById('active-jobs').textContent = data.jobs.active;

                if (data.gpu.memory_percent !== undefined) {
                    document.getElementById('gpu-memory').textContent = `${data.gpu.memory_percent.toFixed(1)}%`;
                }

                // Update chart
                if (gpuChart && data.gpu.memory_percent !== undefined) {
                    const now = new Date().toLocaleTimeString();

                    gpuChart.data.labels.push(now);
                    gpuChart.data.datasets[0].data.push(data.gpu.memory_percent);
                    gpuChart.data.datasets[1].data.push(data.gpu.temperature || 0);

                    // Keep only last 20 data points
                    if (gpuChart.data.labels.length > 20) {
                        gpuChart.data.labels.shift();
                        gpuChart.data.datasets[0].data.shift();
                        gpuChart.data.datasets[1].data.shift();
                    }

                    gpuChart.update('none');
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load Jobs
        async function loadJobs() {
            try {
                const response = await fetch(`${API_BASE}/jobs?limit=10`);
                const data = await response.json();

                const jobsList = document.getElementById('jobs-list');

                if (data.jobs.length === 0) {
                    jobsList.innerHTML = '<p class="text-gray-400">No jobs yet</p>';
                    return;
                }

                jobsList.innerHTML = data.jobs.map(job => createJobCard(job)).join('');

                // Update active jobs tracking
                data.jobs.forEach(job => {
                    if (job.status === 'processing') {
                        activeJobs.set(job.job_id, job);
                    } else {
                        activeJobs.delete(job.job_id);
                    }
                });
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }

        // Load Queue Status
        async function loadQueueStatus() {
            try {
                const response = await fetch(`${API_BASE}/queue`);
                const data = await response.json();

                const queueInfo = document.getElementById('queue-info');

                queueInfo.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-yellow-400">${data.queued_jobs}</p>
                            <p class="text-sm text-gray-400">Queued</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-blue-400">${data.active_workers}/${data.max_workers}</p>
                            <p class="text-sm text-gray-400">Workers</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-400">${data.queued_jobs === 0 ? 'Ready' : 'Busy'}</p>
                            <p class="text-sm text-gray-400">Status</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load queue status:', error);
            }
        }

        // Create Job Card HTML
        function createJobCard(job) {
            const statusColors = {
                'queued': 'text-yellow-400',
                'processing': 'text-blue-400',
                'completed': 'text-green-400',
                'failed': 'text-red-400'
            };

            const statusIcons = {
                'queued': '⏳',
                'processing': '⚡',
                'completed': '✅',
                'failed': '❌'
            };

            return `
                <div class="bg-gray-800 rounded-lg p-4 border-l-4 ${
                    job.status === 'processing' ? 'border-blue-500 generating' :
                    job.status === 'completed' ? 'border-green-500' :
                    job.status === 'failed' ? 'border-red-500' : 'border-yellow-500'
                }">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${statusIcons[job.status] || '📋'}</span>
                            <div>
                                <p class="font-medium ${statusColors[job.status] || ''}">${job.status.toUpperCase()}</p>
                                <p class="text-sm text-gray-400">ID: ${job.job_id.substring(0, 8)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-400">${new Date(job.created_at).toLocaleTimeString()}</p>
                            ${job.status === 'processing' ?
                                `<div class="w-20 bg-gray-700 rounded-full h-2 mt-2">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${job.progress || 0}%"></div>
                                </div>` : ''
                            }
                            ${job.status === 'completed' && job.output_path ?
                                `<button onclick="downloadVideo('${job.job_id}')" class="mt-2 bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">
                                    📥 Download
                                </button>` : ''
                            }
                        </div>
                    </div>
                    ${job.prompt ? `<p class="mt-2 text-sm text-gray-300 line-clamp-2">${job.prompt}</p>` : ''}
                    ${job.error_message ? `<p class="mt-2 text-sm text-red-400">Error: ${job.error_message}</p>` : ''}
                </div>
            `;
        }

        // Setup Form Handlers
        function setupFormHandlers() {
            const form = document.getElementById('video-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            const submitText = document.getElementById('submit-text');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = {
                    prompt: document.getElementById('prompt').value,
                    quality_preset: document.getElementById('quality-preset').value,
                    template: document.getElementById('template').value,
                    frames: parseInt(document.getElementById('frames').value),
                    fps: parseInt(document.getElementById('fps').value),
                    noise_level: document.getElementById('noise-level').value,
                    priority: parseInt(document.getElementById('priority').value)
                };

                // Handle file upload
                const imageFile = document.getElementById('image-upload').files[0];
                if (imageFile) {
                    // For now, skip file upload in this demo
                    console.log('Image upload would be handled here');
                }

                // Disable submit button
                submitBtn.disabled = true;
                submitText.textContent = '⏳ Submitting...';

                try {
                    const response = await fetch(`${API_BASE}/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        submitText.textContent = '✅ Submitted!';
                        form.reset();

                        // Refresh jobs list
                        setTimeout(() => {
                            loadJobs();
                            submitBtn.disabled = false;
                            submitText.textContent = '🚀 Generate Video';
                        }, 1500);
                    } else {
                        throw new Error(result.error || 'Submission failed');
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                    submitBtn.disabled = false;
                    submitText.textContent = '🚀 Generate Video';
                }
            });

            // Template quick buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const template = this.dataset.template;
                    document.getElementById('template').value = template;

                    // Update prompt based on template
                    const templatePrompts = {
                        'subtle_breathing': 'a portrait with subtle breathing movement',
                        'gentle_pulse': 'a glowing orb with gentle pulsing',
                        'slow_pan': 'a landscape with slow cinematic panning',
                        'wind_sway': 'trees swaying gently in the wind'
                    };

                    document.getElementById('prompt').value = templatePrompts[template] || '';
                });
            });
        }

        // Download Video
        async function downloadVideo(jobId) {
            try {
                window.open(`${API_BASE}/jobs/${jobId}/download`, '_blank');
            } catch (error) {
                alert(`Download failed: ${error.message}`);
            }
        }

        // Status Indicator Updates
        setInterval(function() {
            const indicator = document.getElementById('status-indicator');
            const isConnected = navigator.onLine;

            indicator.innerHTML = `
                <span class="w-3 h-3 ${isConnected ? 'bg-green-500' : 'bg-red-500'} rounded-full mr-2"></span>
                <span class="text-sm">${isConnected ? 'Connected' : 'Offline'}</span>
            `;
        }, 5000);
    </script>
</body>
</html>